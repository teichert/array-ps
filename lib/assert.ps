% Test tracking variables (exception: test framework needs global state)
/test-count 0 def
/test-passed 0 def
/test-failed 0 def
/test-correct-failures 0 def
/suppress-failure-output false def

% test-report: ( -- )
% Report test results and exit with appropriate code
/test-report {
  (Test Results:) =                                % --
  (  Total:             ) print                    % --
  test-count =                                     % --
  (  Passed:            ) print                    % --
  test-passed =                                    % --
  (  Correct Failures:  ) print                    % --
  test-correct-failures =                          % --
  (  Failed:            ) print                    % --
  test-failed =                                    % --
  test-failed 0 gt                                 % bool
  { 1 }                                            % 1
  { 0 }                                            % 0
  ifelse                                           % exit-code
  quit                                             % --
} def

% arrays-equal: ( array1 array2 -- bool )
% Compare two arrays for deep equality  
/arrays-equal {
	% Save arrays to variables for easier access
	/arr2 exch def                                  % array1
	/arr1 exch def                                  % --
	
	% Check lengths
	arr1 length arr2 length eq                      % lengths-equal?
	{
		% Same length, check elements
		true                                        % result
		0 1 arr1 length 1 sub                       % result start step end
		{
			% Compare element at index i  
			/i exch def                             % result
			arr1 i get                              % result arr1[i]
			arr2 i get                              % result arr1[i] arr2[i]
			elements-equal                          % result elements-equal?
			and                                     % combined-result
		} for                                      % final-result
	}{
		% Different lengths
		false                                      % false
	} ifelse                                       % result
} def

% elements-equal: ( element1 element2 -- bool )
% Compare two elements, handling arrays recursively
/elements-equal {
	2 copy                                          % elem1 elem2 elem1 elem2
	type /arraytype eq                              % elem1 elem2 elem1 is-array?
	exch type /arraytype eq                         % elem1 elem2 is-array? elem2-is-array?
	and                                             % elem1 elem2 both-arrays?
	{
		arrays-equal                               % result
	}{
		eq                                         % result
	} ifelse                                       % result
} def

% assert-stack: ( message code-block expected-array -- )
% Execute code block and compare resulting stack with expected array
/assert-stack {
	/test-count test-count 1 add def               % message code-block expected-array
	
	% Save inputs to local variables
	/expected exch def                              % message code-block
	/code-block exch def                           % message
	/message exch def                              % --
	
	% Execute code block and capture result as array
	mark                                           % mark
	code-block exec                                % mark ...results...
	counttomark                                    % mark ...results... count
	array astore                                   % actual-array
	/actual exch def                               % --
	cleartomark                                    % --
	
	% Compare arrays using deep equality
	actual                                          % actual
	expected                                        % actual expected
	arrays-equal                                    % comparison-result
	
	% Handle test result
	{
		% Test passed
		/test-passed test-passed 1 add def         % --
	}{
		% Test failed
		/test-failed test-failed 1 add def         % --
		suppress-failure-output not                 % should-print?
		{
			(Assertion failed: ) print              % --
			message =                               % --
			(  Code:     ) print                    % --
			code-block ==                           % --
			(  Actual:   ) print                    % --
			actual ==                               % --
			(  Expected: ) print                    % --
			expected ==                             % --
		} if                                       % --
		% Don't stop - continue with other tests   % --
	} ifelse                                       % --
} def

% assert-fails: ( assertion-block -- )
% Execute assertion block and verify it fails (increments failure count)
/assert-fails {
	/test-count test-count 1 add def               % assertion-block
	/assertion-block exch def                       % --
	
	% Save current test counts to detect if assertion incremented them
	/saved-passed test-passed def                   % --
	/saved-failed test-failed def                   % --
	
	% Enable output suppression for expected failures
	/suppress-failure-output true def               % --
	
	% Execute the assertion block
	assertion-block exec                            % --
	
	% Restore output suppression
	/suppress-failure-output false def              % --
	
	% Check if the assertion failed as expected
	test-failed saved-failed gt                     % assertion-failed?
	{
		% Assertion failed as expected
		% Reset test counts to saved values since the inner assertion shouldn't count
		/test-passed saved-passed def              % --
		/test-failed saved-failed def              % --
		/test-passed test-passed 1 add def         % --
		/test-correct-failures test-correct-failures 1 add def % --
	}{
		% Assertion passed when it should have failed
		% Reset test counts to saved values
		/test-passed saved-passed def              % --
		/test-failed saved-failed def              % --
		/test-failed test-failed 1 add def         % --
		(Assert-fails failed: Expected assertion to fail but it passed) =
		(  Assertion: ) print                       % --
		assertion-block ==                          % --
	} ifelse                                       % --
} def
